name: CI Pipeline - Full Verification

# Déclencher sur les PRs et les pushes vers main
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ----------------------------------------------------------------------
  # 3. & 4. CODE QUALITY & AUTO-FORMAT FIX (Linter & Format Check)
  # ----------------------------------------------------------------------
  code_quality:
    name: Code Quality & Auto-Format Fix
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Nécessaire pour l'auto-commit
          fetch-depth: 0 

      - name: Setup environment (Node.js)
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          
      - name: Install dependencies (Linter, Formatter, etc.)
        # Utiliser npm install si vos outils sont des devDependencies dans package.json
        run: npm install 

      # --- 3. Format Check (Vérifier sans corriger) ---
      - name: 3. Format Check (Verify)
        # **ACTION REQUISE : ADAPTER CETTE COMMANDE** (Ex: prettier --check, black --check, etc.)
        run: npm run format:check # Supposons que vous avez une commande pour vérifier le format
        continue-on-error: true 
        id: format_check 

      # --- 4. Linter Check ---
      - name: 4. Linter Run
        # **ACTION REQUISE : ADAPTER CETTE COMMANDE** (Ex: npx eslint ., pylint, golangci-lint, etc.)
        run: npm run lint # Supposons que vous avez une commande pour linter

      # --- Auto-Format Fix et Commit ---
      - name: Auto-Format Fix and Commit
        if: steps.format_check.outcome == 'failure'
        run: |
          echo "Format check failed. Attempting automatic fix."
          # **ACTION REQUISE : ADAPTER CETTE COMMANDE** (Ex: prettier --write, black, etc.)
          npm run format:fix # Supposons que vous avez une commande pour corriger le format
          
          # Configuration et commit du bot
          git status --porcelain
          if [[ -z $(git status --porcelain) ]]; then
            echo "No changes after formatter. Skipping commit."
          else
            git config user.name github-actions[bot]
            git config user.email github-actions[bot]@users.noreply.github.com
            git add .
            git commit -m "style: Auto-fix formatting errors" 
            git push
            echo "Code formatting fixed and committed to PR branch."
          fi
  
  # ----------------------------------------------------------------------
  # 7. APP BUILD CHECK (Compilation et Vérification des dépendances)
  # ----------------------------------------------------------------------
  app_build_check:
    name: 7. Application Build Check
    runs-on: ubuntu-latest
    needs: [code_quality] 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup environment (Node.js)
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies & Compile/Build
        # Compile/build application et vérifie toutes les dépendances
        # **ACTION REQUISE : ADAPTER CETTE COMMANDE** (Ex: npm install, npm run build, go build, etc.)
        run: |
          npm install 
          npm run build # La commande de compilation/build de votre application (si elle existe)
          
      - name: Check build artifacts (Vérifier les livrables de compilation)
        # Par exemple, vérifier l'existence d'un répertoire 'dist' ou d'un binaire
        run: echo "Artifact check successful." # À remplacer par une vérification réelle
  
  # ----------------------------------------------------------------------
  # 6. DOCKER BUILD CHECK (Vérification de l'image)
  # ----------------------------------------------------------------------
  docker_build_check:
    name: 6. Docker Build Check
    runs-on: ubuntu-latest
    # Dépend de la compilation de l'application (l'image Docker a souvent besoin des artefacts compilés)
    needs: [app_build_check] 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image, Verify, and Check Size
        run: |
          docker build --no-cache -f Dockerfile -t local-app-check:latest .
          echo "Docker image built successfully."
          # Logique de vérification de taille ici (comme vu précédemment)
          IMAGE_SIZE=$(docker inspect --format='{{.Size}}' local-app-check:latest)
          IMAGE_SIZE_MB=$((IMAGE_SIZE / 1024 / 1024))
          echo "Image size: ${IMAGE_SIZE_MB}MB"
          if [ $IMAGE_SIZE_MB -gt 150 ]; then # Exemple de limite
            echo "::warning::Image size is large: ${IMAGE_SIZE_MB}MB. Consider further optimization."
          fi

  # ----------------------------------------------------------------------
  # 1. & 2. CORE TESTS (Unit & E2E Tests)
  # Nous les lançons après le Build Check car les tests E2E ont besoin de l'image Docker
  # ----------------------------------------------------------------------
  tests:
    name: 1. Unit & 2. E2E Tests
    runs-on: ubuntu-latest
    # Dépend de la vérification de build Docker
    needs: [docker_build_check] 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment (Node.js)
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies (pour exécuter les tests)
        run: npm install 

      # 1. Unit Tests
      - name: 1. Run Unit Tests
        # **ACTION REQUISE : ADAPTER CETTE COMMANDE**
        run: npm run test:unit 

      # 2. E2E Tests - Nécessite de démarrer les conteneurs
      - name: Start services (App, DB, etc.) with Docker Compose
        # Démarrer tous les services nécessaires pour les E2E
        run: docker compose up -d
        
      - name: 2. Run E2E Tests
        # **ACTION REQUISE : ADAPTER CETTE COMMANDE**
        run: npm run test:e2e 
        
      - name: Stop services
        if: always() # S'assurer que les conteneurs sont arrêtés même si les tests échouent
        run: docker compose down


  # ----------------------------------------------------------------------
  # 5. DOCUMENTATION BUILD CHECK
  # ----------------------------------------------------------------------
  documentation_check:
    name: 5. Documentation Build Check (README)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Verify documentation can be built (Ex: Jekyll, Sphinx)
        # Si vous n'avez pas de build doc, laissez un echo ou vérifiez l'existence d'un fichier clé
        run: echo "Documentation build verification successful (no complex build detected)."
        
      - name: Check for broken links (incl. README)
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-curl: yes
          # Lit le README et tous les fichiers markdown pour les liens brisés
          check-path: '.'