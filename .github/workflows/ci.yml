name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  install:
    name: Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

  format:
    needs: install
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Check formatting
        run: pnpm format:check

  lint:
    needs: install
    name: Lint Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Run linter
        run: pnpm lint

  unit-tests:
    needs: [format, lint]
    name: Unit Tests
    
    # Stratégie pour exécuter les tests sur différents environnements (si nécessaire)
    strategy:
      matrix:
        node-version: [20.x] # Ajuster pour Python, Go, etc.

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment (ex: Node.js)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      # 1. Unit Tests
      - name: Run Unit Tests
        run: pnpm test

      # 2. E2E Tests
      - name: Install Playwright Browsers
        run: pnpm playwright install --with-deps
        
      - name: Run E2E Tests
        run: pnpm run e2e

  # ----------------------------------------------------------------------
  # 7. APP BUILD CHECK (Vérification de compilation)
  # ----------------------------------------------------------------------
  app_build_check:
    name: Application Build Check
    runs-on: ubuntu-latest
    needs: [code_quality] # S'assurer que le code est propre avant de construire
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup environment (ex: Node.js)
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies & Build
        run: |
          pnpm install 
          pnpm run build

      # Optionnel : Sauvegarder les artefacts de build si besoin
      - name: Check build artifacts (ex: check 'dist' directory exists)
        run: |
          if [ ! -d "dist" ]; then
            echo "::error::Build failed: dist directory not found."
            exit 1
          fi

  # ----------------------------------------------------------------------
  # 6. DOCKER BUILD CHECK (Vérification de l'image Docker)
  # ----------------------------------------------------------------------
  docker_build_check:
    name: Docker Build Check
    runs-on: ubuntu-latest
    # Dépend de la vérification de build de l'application (le code doit compiler avant d'être conteneurisé)
    needs: [app_build_check] 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image and verify
        # Construit l'image et la tagge (sans la pousser)
        run: |
          # Utiliser la commande standard de build
          docker build --no-cache -f Dockerfile -t local-app-check:latest .
          echo "Docker image built successfully."
          
          # Vérification simple de la taille (exemple de vérification d'optimisation)
          IMAGE_SIZE=$(docker inspect --format='{{.Size}}' local-app-check:latest)
          # Convertir la taille en Mo pour le log
          IMAGE_SIZE_MB=$((IMAGE_SIZE / 1024 / 1024))
          echo "Image size: ${IMAGE_SIZE_MB}MB"
          
          # Exemple de test d'optimisation : fail si > 100 Mo
          if [ $IMAGE_SIZE_MB -gt 100 ]; then
            echo "::warning::Image size is large: ${IMAGE_SIZE_MB}MB. Consider further optimization."
          fi


  # ----------------------------------------------------------------------
  # 5. DOCUMENTATION BUILD CHECK
  # ----------------------------------------------------------------------
  documentation_check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check for broken links in Markdown files (incl. README)
        # Action populaire pour vérifier les liens brisés dans les fichiers Markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-curl: yes
          # Réglage pour ignorer certains liens si nécessaire
          config-file: '.markdown-link-check.json' # Fichier de configuration optionnel
          
      # Exemple d'étape pour "vérifier que le README est à jour" (logique à définir)
      - name: Check README for basic content
        run: |
          # Vérifier si le README contient le titre du projet par exemple
          if ! grep -q "2025-devops-ci" README.md; then
            echo "::warning::README.md might be incomplete (missing project title)"
          fi