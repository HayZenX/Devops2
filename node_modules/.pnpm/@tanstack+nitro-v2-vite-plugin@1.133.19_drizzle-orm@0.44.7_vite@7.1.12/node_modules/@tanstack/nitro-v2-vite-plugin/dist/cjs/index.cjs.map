{"version":3,"file":"index.cjs","sources":["../../src/index.ts"],"sourcesContent":["import { build, copyPublicAssets, createNitro, prepare } from 'nitropack'\nimport { dirname, resolve } from 'pathe'\n\nimport type { PluginOption, ResolvedConfig, Rollup } from 'vite'\nimport type { NitroConfig } from 'nitropack'\n\nlet ssrBundle: Rollup.OutputBundle\nlet ssrEntryFile: string\n\nfunction isFullUrl(str: string): boolean {\n  try {\n    new URL(str)\n    return true\n  } catch {\n    return false\n  }\n}\n\nexport function nitroV2Plugin(nitroConfig?: NitroConfig): Array<PluginOption> {\n  let resolvedConfig: ResolvedConfig\n  return [\n    {\n      name: 'tanstack-nitro-v2-vite-plugin',\n\n      generateBundle: {\n        handler(_options, bundle) {\n          if (this.environment.name !== 'ssr') {\n            return\n          }\n\n          // find entry point of ssr bundle\n          let entryFile: string | undefined\n          for (const [_name, file] of Object.entries(bundle)) {\n            if (file.type === 'chunk') {\n              if (file.isEntry) {\n                if (entryFile !== undefined) {\n                  this.error(\n                    `Multiple entry points found for service \"${this.environment.name}\". Only one entry point is allowed.`,\n                  )\n                }\n                entryFile = file.fileName\n              }\n            }\n          }\n          if (entryFile === undefined) {\n            this.error(\n              `No entry point found for service \"${this.environment.name}\".`,\n            )\n          }\n          ssrEntryFile = entryFile!\n          ssrBundle = bundle\n        },\n      },\n\n      configResolved(config) {\n        resolvedConfig = config\n      },\n      config(_, env) {\n        if (env.command !== 'build') {\n          return\n        }\n\n        return {\n          environments: {\n            ssr: {\n              consumer: 'server',\n              build: {\n                ssr: true,\n                // we don't write to the file system as the below 'capture-output' plugin will\n                // capture the output and write it to the virtual file system\n                write: false,\n                copyPublicDir: false,\n                commonjsOptions: {\n                  include: [/node_modules/],\n                },\n              },\n            },\n          },\n          builder: {\n            sharedPlugins: true,\n            async buildApp(builder) {\n              const client = builder.environments.client\n              const server = builder.environments.ssr\n\n              if (!client) {\n                throw new Error('Client environment not found')\n              }\n\n              if (!server) {\n                throw new Error('SSR environment not found')\n              }\n\n              await builder.build(client)\n              await builder.build(server)\n\n              const virtualEntry = '#tanstack/start/entry'\n              const baseURL = !isFullUrl(resolvedConfig.base)\n                ? resolvedConfig.base\n                : undefined\n              const config: NitroConfig = {\n                baseURL,\n                publicAssets: [\n                  {\n                    dir: client.config.build.outDir,\n                    maxAge: 31536000, // 1 year\n                    baseURL: '/',\n                  },\n                ],\n                ...nitroConfig,\n                esbuild: {\n                  options: {\n                    target: server.config.build.target || undefined,\n                    ...nitroConfig?.esbuild?.options,\n                  },\n                },\n                renderer: virtualEntry,\n                rollupConfig: {\n                  ...nitroConfig?.rollupConfig,\n                  plugins: [virtualBundlePlugin(ssrBundle) as any],\n                },\n                virtual: {\n                  ...nitroConfig?.virtual,\n                  [virtualEntry]: `import { fromWebHandler } from 'h3'\n                                    import handler from '${ssrEntryFile}' \n                                    export default fromWebHandler(handler.fetch)`,\n                },\n              }\n\n              const nitro = await createNitro(config)\n\n              await prepare(nitro)\n              await copyPublicAssets(nitro)\n              await build(nitro)\n\n              await nitro.close()\n            },\n          },\n        }\n      },\n    },\n  ]\n}\n\nfunction virtualBundlePlugin(bundle: Rollup.OutputBundle): Rollup.Plugin {\n  type VirtualModule = { code: string; map: string | null }\n  let _modules: Map<string, VirtualModule> | null = null\n\n  // lazy initialize _modules since at the time of plugin creation, the bundles are not available yet\n  const getModules = () => {\n    if (_modules) {\n      return _modules\n    }\n    _modules = new Map()\n    // group chunks and source maps\n    for (const [fileName, content] of Object.entries(bundle)) {\n      if (content.type === 'chunk') {\n        const virtualModule: VirtualModule = {\n          code: content.code,\n          map: null,\n        }\n        const maybeMap = bundle[`${fileName}.map`]\n        if (maybeMap && maybeMap.type === 'asset') {\n          virtualModule.map = maybeMap.source as string\n        }\n        _modules.set(fileName, virtualModule)\n        _modules.set(resolve(fileName), virtualModule)\n      }\n    }\n    return _modules\n  }\n\n  return {\n    name: 'virtual-bundle',\n    resolveId(id, importer) {\n      const modules = getModules()\n      if (modules.has(id)) {\n        return resolve(id)\n      }\n\n      if (importer) {\n        const resolved = resolve(dirname(importer), id)\n        if (modules.has(resolved)) {\n          return resolved\n        }\n      }\n      return null\n    },\n    load(id) {\n      const modules = getModules()\n      const m = modules.get(id)\n      if (!m) {\n        return null\n      }\n      return m\n    },\n  }\n}\n"],"names":["createNitro","prepare","copyPublicAssets","build","resolve","dirname"],"mappings":"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"}